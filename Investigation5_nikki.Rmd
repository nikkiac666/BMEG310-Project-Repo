---
title: "BRCA_investigation5"
author: "Nikki Comfort (47041595)"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
#install.packages("xfun")
#install.packages("patchwork")

library(DESeq2)
library(biomaRt)
library(pheatmap)
library(ggplot2)
```

```{r Load Files}
clinical <- read.csv("data_clinical_patient.txt", sep = "\t", header = TRUE, skip = 4)
mutations <- read.csv("data_mutations.txt", sep = "\t", header = TRUE)
rnaseq <- read.csv("RNAseq_BRCA.csv", header = TRUE)
```

Data Normalization:
```{r data normalization}
# Configure raw rnaseq data:
gene_colname <- colnames(rnaseq)[1]

gene_ids <- rnaseq[[gene_colname]]

count_mat <- rnaseq[, -1]
count_mat <- as.matrix(count_mat)

rownames(count_mat) <- gene_ids

# DESeq2 Dataset:
sample_info <- data.frame(row.names = colnames(count_mat),
                          condition = rep("BRCA", ncol(count_mat)))

dds <- DESeqDataSetFromMatrix(
  countData = count_mat,
  colData = sample_info,
  design = ~ 1
)

# Size factor normalization
dds <- estimateSizeFactors(dds)
norm_counts <- counts(dds, normalized = TRUE)
rna_norm <- log2(norm_counts + 1)

#head(rownames(rna_norm))
#head(colnames(rna_norm))
#dim(rna_norm)
```

Gene Symbol Mapping:
```{r Ensembl}
# Remove version suffix after dot
ensembl_ids <- gsub("\\..*", "", rownames(rna_norm))

mart <- useMart("ensembl", dataset = "hsapiens_gene_ensembl")

gene_map <- getBM(
  attributes = c("ensembl_gene_id", "hgnc_symbol"),
  filters = "ensembl_gene_id",
  values = ensembl_ids,
  mart = mart
)

# Remove rows with missing symbols:
gene_map <- gene_map[gene_map$hgnc_symbol != "", ]

idx <- match(ensembl_ids, gene_map$ensembl_gene_id)

# Filter normalized matrix to mapped genes only:
rna_symbol <- rna_norm[!is.na(idx), ]

# Assign gene symbols as rownames:
rownames(rna_symbol) <- gene_map$hgnc_symbol[idx[!is.na(idx)]]

# Remove duplicated gene symbols:
rna_symbol <- rna_symbol[!duplicated(rownames(rna_symbol)), ]

head(rownames(rna_symbol))
dim(rna_symbol)
```
```{r z-score}
rna_mat <- as.matrix(rna_symbol)

gene_means <- rowMeans(rna_mat, na.rm = TRUE)
gene_sds <- apply(rna_mat, 1, sd, na.rm = TRUE)

# avoid divide by zero: set sd=NA where sd=0
gene_sds[gene_sds == 0 | is.na(gene_sds)] <- NA

rna_z <- (rna_mat - gene_means) / gene_sds

#checks:
mean_of_row_means <- summary(rowMeans(rna_z, na.rm = TRUE))
sd_of_row_sds <- summary(apply(rna_z, 1, sd, na.rm = TRUE))

mean_of_row_means
sd_of_row_sds
#summary(rna_z)
```

Load leukocyte signature matrix (LM22) gene signatures:
```{r LM22}
LM22 <- list(
  "B_cells_naive" = c("MS4A1", "CD19", "FCRL1", "BANK1", "CD79A", "CD79B"),
  "B_cells_memory" = c("CD27", "CD38", "TNFRSF13B", "FCRL4"),
  "Plasma_cells" = c("SDC1", "MZB1", "XBP1", "CD38"),
  "T_cells_CD8" = c("CD8A", "CD8B"),
  "T_cells_CD4_naive" = c("CCR7", "LEF1", "TCF7"),
  "T_cells_CD4_memory_resting" = c("IL7R", "CCR7", "CCR6"),
  "T_cells_CD4_memory_activated" = c("IL7R", "IL2RA", "CD40LG"),
  "T_cells_follicular_helper" = c("CXCR5", "BCL6", "ICOS"),
  "Tregs" = c("FOXP3", "IL2RA", "CTLA4"),
  "T_cells_gamma_delta" = c("TRDC", "TRGC1", "TRGC2"),
  "NK_cells_resting" = c("KLRD1", "NKG7"),
  "NK_cells_activated" = c("GZMB", "GNLY", "PRF1"),
  "Monocytes" = c("LYZ", "FCGR3A", "S100A8", "S100A9"),
  "Macrophages_M0" = c("MS4A7", "C1QA", "C1QB"),
  "Macrophages_M1" = c("NOS2", "IL6", "TNF", "CXCL10"),
  "Macrophages_M2" = c("MRC1", "MSR1", "IL10", "CD163"),
  "Dendritic_cells_resting" = c("HLA-DPA1", "HLA-DPB1", "HLA-DRA"),
  "Dendritic_cells_activated" = c("ITGAX", "CD83"),
  "Mast_cells_resting" = c("TPSAB1", "TPSB2"),
  "Mast_cells_activated" = c("CPA3", "TPSAB1"),
  "Eosinophils" = c("CLC", "RNASE2"),
  "Neutrophils" = c("FCGR3B", "S100A12", "CEACAM8")
)
```

Immune Infiltration scores:
```{r LM22 scoring}
immune_scores <- sapply(LM22, function(gset){
  overlap <- intersect(gset, rownames(rna_z))
  if (length(overlap) == 0) {
    return(rep(NA, ncol(rna_z)))
  } 
  colMeans(rna_z[overlap, , drop = FALSE], na.rm = TRUE)
})

immune_scores <- as.data.frame(immune_scores)
immune_scores$patient <- colnames(rna_z)

dim(immune_scores)
#head(immune_scores)
#sapply(LM22, function(gset) length(intersect(gset, rownames(rna_z)))) # tells how many genes from each signature are present in the data
#head(rownames(immune_scores))
```

```{r merge with clinical}
# First clean patient IDs to have same format in order to merge:
immune_scores$sample_id <-gsub("\\.", "-", colnames(rna_z))
immune_scores$PATIENT_ID <- substr(immune_scores$sample_id, 1, 12)
immune_scores$patient <- NULL
#head(immune_scores$PATIENT_ID)

merged <- merge(
  clinical,
  immune_scores,
  by = "PATIENT_ID"
)

dim(merged)
head(merged[, 1:8])
```

Visualizations:
```{r Figure 5.1 Heatmap}
# First configure immune_scores matrix for heatmapping
immune_mat <- immune_scores[, !(names(immune_scores) %in% c("sample_id", "PATIENT_ID"))]
dim(immune_mat)
#colnames(immune_mat)
immune_mat_scaled <- scale(immune_mat)

pheatmap(
  immune_mat_scaled,
  show_rownames = FALSE,
  fontsize_col = 10,
  clustering_distance_rows = "euclidean",
  clustering_distance_cols = "euclidean",
  clustering_method = "complete",
  main = "Figure 5.1: Immune Cell Infiltration (LM22) Heatmap"
)
```

```{r Figure 5.2 Boxplot}
ggplot(merged_data, aes(x = AJCC_PATHOLOGIC_TUMOR_STAGE, y = T_cells_CD8)) +
  geom_boxplot() +
  theme_bw()
```

```{r Figure 5.3 Survival Analysis}
merged_data$OS <- ifelse(merged_data$vital_status == "Dead", 1, 0)

fit <- survfit(Surv(OS_TIME, OS) ~ T_cells_CD8_group, data = merged_data)

ggsurvplot(fit, data = merged_data)
```

